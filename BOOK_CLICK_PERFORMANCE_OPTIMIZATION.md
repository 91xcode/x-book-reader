# ğŸ“ˆ ä¹¦ç±ç‚¹å‡»æ€§èƒ½ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³new-x-projectä¸­"ç‚¹å‡»ä¹¦ç±è·³è½¬åˆ°readeré¡µé¢æ¸²æŸ“å¾ˆæ…¢"çš„é—®é¢˜ï¼Œé€šè¿‡å¯¹æ¯”readesté¡¹ç›®çš„æœ€ä½³å®è·µï¼Œå®ç°å…¨é¢çš„æ€§èƒ½ä¼˜åŒ–ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
- ç‚¹å‡»ä¹¦ç±åéœ€è¦ç­‰å¾…è¾ƒé•¿æ—¶é—´æ‰èƒ½è¿›å…¥é˜…è¯»ç•Œé¢
- ç”¨æˆ·ä½“éªŒä¸å¤Ÿæµç•…ï¼Œæ„Ÿè§‰åº”ç”¨ååº”è¿Ÿé’
- ç¼ºå°‘é¢„å¤„ç†æœºåˆ¶ï¼Œæ‰€æœ‰å¤„ç†éƒ½åœ¨readeré¡µé¢è¿›è¡Œ

### å¯¹æ¯”readesté¡¹ç›®å‘ç°çš„å…³é”®å·®å¼‚
1. **ç¼ºå°‘é¢„å¤„ç†æœºåˆ¶**: new-x-projectç›´æ¥è·³è½¬ï¼Œreadestä¼šå…ˆé¢„å¤„ç†
2. **åŒæ­¥å¯¼èˆª**: new-x-projectä½¿ç”¨åŒæ­¥å¯¼èˆªï¼Œå¯èƒ½é˜»å¡UI
3. **åŠ è½½çŠ¶æ€é—ªçƒ**: ç«‹å³æ˜¾ç¤ºloadingï¼Œå¿«é€Ÿæ“ä½œæ—¶é€ æˆé—ªçƒ
4. **é‡å¤æ£€æŸ¥**: æ²¡æœ‰ç¼“å­˜å¯ç”¨æ€§çŠ¶æ€ï¼Œæ¯æ¬¡éƒ½é‡æ–°æ£€æŸ¥
5. **ç¼ºå°‘å¤šå±‚æ¬¡é¢„åŠ è½½**: æ²¡æœ‰åå°é¢„æ£€æŸ¥å’Œé¢„çƒ­æœºåˆ¶

## ğŸš€ å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ğŸ“š ä¹¦ç±é¢„å¤„ç†æœºåˆ¶ âœ…

**å®ç°**: åœ¨BookServiceV2ä¸­æ·»åŠ `makeBookAvailable`æ–¹æ³•

```typescript
// BookServiceV2.ts - æ–°å¢æ–¹æ³•
async makeBookAvailable(book: Book, options = {}): Promise<boolean> {
  // 1. æ£€æŸ¥ç¼“å­˜çš„å¯ç”¨æ€§çŠ¶æ€
  // 2. å®é™…æ£€æŸ¥ä¹¦ç±å¯ç”¨æ€§
  // 3. ç¼“å­˜ç»“æœ
  // 4. å»¶è¿Ÿæ˜¾ç¤ºloadingé¿å…é—ªçƒ
}

async isBookAvailable(book: Book): Promise<boolean> {
  // å¿«é€Ÿæ£€æŸ¥ä¹¦ç±æ–‡ä»¶æ˜¯å¦å­˜åœ¨
}
```

**æ•ˆæœ**: 
- åœ¨ç‚¹å‡»æ—¶å°±é¢„å…ˆéªŒè¯å’Œå‡†å¤‡ä¹¦ç±æ•°æ®
- é¿å…åœ¨readeré¡µé¢æ‰å¼€å§‹å¤„ç†
- æä¾›é™çº§æœºåˆ¶ç¡®ä¿åŠŸèƒ½å¯é æ€§

### 2. âš¡ å¼‚æ­¥å¯¼èˆªä¼˜åŒ– âœ…

**å®ç°**: ä½¿ç”¨`setTimeout(0)`å®ç°éé˜»å¡å¯¼èˆª

```typescript
// Libraryé¡µé¢ - ä¿®æ”¹å
const handleBookClick = async (bookHash: string) => {
  // é¢„å¤„ç†...
  
  // å¼‚æ­¥å¯¼èˆª
  setTimeout(() => {
    router.push(`/reader?ids=${bookHash}`)
  }, 0)
}
```

**æ•ˆæœ**:
- å¯¼èˆªæ“ä½œä¸å†é˜»å¡UIçº¿ç¨‹
- ç”¨æˆ·æ„ŸçŸ¥æ›´æµç•…
- ç±»ä¼¼readestçš„å®ç°æ–¹å¼

### 3. ğŸ¯ æ™ºèƒ½åŠ è½½æŒ‡ç¤ºå™¨ âœ…

**å®ç°**: å»¶è¿Ÿ300msæ˜¾ç¤ºloadingï¼Œé¿å…å¿«é€Ÿæ“ä½œæ—¶é—ªçƒ

```typescript
// Readeré¡µé¢ - ä¼˜åŒ–å
useEffect(() => {
  // å»¶è¿Ÿæ˜¾ç¤ºloading
  loadingTimeoutRef.current = setTimeout(() => {
    setShowLoading(true)
  }, 300)
  
  // å¤„ç†å®Œæˆåæ¸…é™¤
  if (loadingTimeoutRef.current) {
    clearTimeout(loadingTimeoutRef.current)
  }
  setShowLoading(false)
}, [])

// æ™ºèƒ½æ˜¾ç¤ºæ¡ä»¶
if (!bookKey || (viewState?.loading && showLoading)) {
  return <LoadingComponent />
}
```

**æ•ˆæœ**:
- æ¶ˆé™¤å¿«é€ŸåŠ è½½æ—¶çš„é—ªçƒæ•ˆæœ
- åªåœ¨çœŸæ­£éœ€è¦æ—¶æ˜¾ç¤ºloading
- æå‡ç”¨æˆ·ä½“éªŒ

### 4. ğŸ’¾ çŠ¶æ€æŒä¹…åŒ–å¢å¼º âœ…

**å®ç°**: åœ¨BookDataStoreä¸­æ·»åŠ å¯ç”¨æ€§çŠ¶æ€ç¼“å­˜

```typescript
// bookDataStore.ts - æ‰©å±•æ¥å£
interface BookData {
  // åŸæœ‰å­—æ®µ...
  availabilityStatus?: {
    available: boolean
    fileExists: boolean
    lastChecked: number
    checkDuration: number
  }
}

// æ–°å¢æ–¹æ³•
getAvailabilityStatus(id: string)
setAvailabilityStatus(id: string, status)
isAvailabilityStatusExpired(id: string, maxAge = 5 * 60 * 1000)
```

**æ•ˆæœ**:
- é¿å…é‡å¤æ£€æŸ¥ä¹¦ç±å¯ç”¨æ€§
- 5åˆ†é’Ÿå†…çš„æ£€æŸ¥ç»“æœä¼šè¢«ç¼“å­˜
- æä¾›æ€§èƒ½åˆ†ææ•°æ®

### 5. ğŸ”„ å¤šå±‚æ¬¡é¢„åŠ è½½ç³»ç»Ÿ âœ…

**å®ç°**: åˆ›å»ºPreloadManagerç®¡ç†å™¨

```typescript
// PreloadManager.ts - æ–°æ–‡ä»¶
export class PreloadManager {
  // é¢„åŠ è½½Libraryä¸­çš„ä¹¦ç±
  async preloadLibraryBooks(books: Book[], options: PreloadOptions)
  
  // é¢„çƒ­ç‰¹å®šä¹¦ç±
  async preheatBook(bookId: string): Promise<boolean>
  
  // åå°æ£€æŸ¥å¯ç”¨æ€§
  async backgroundCheckAvailability(books: Book[])
  
  // è·å–é¢„åŠ è½½çŠ¶æ€
  getBookPreloadStatus(bookId: string)
}
```

**é›†æˆç‚¹**:
- **Libraryé¡µé¢åŠ è½½æ—¶**: åå°é¢„æ£€æŸ¥æ‰€æœ‰ä¹¦ç±å¯ç”¨æ€§
- **ä¹¦ç±hoveræ—¶**: é¢„çƒ­ä¹¦ç±ï¼Œå‡†å¤‡å¿«é€Ÿæ‰“å¼€
- **ä¹¦ç±ç‚¹å‡»æ—¶**: ä½¿ç”¨é¢„çƒ­ç»“æœï¼Œå¿«é€Ÿå“åº”

## ğŸ“Š æ€§èƒ½æå‡æ•ˆæœ

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| é˜¶æ®µ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| ç‚¹å‡»å“åº” | åŒæ­¥å¤„ç†ï¼ŒUIé˜»å¡ | å¼‚æ­¥é¢„çƒ­ï¼Œç«‹å³å“åº” | âš¡ å³æ—¶å“åº” |
| ä¹¦ç±æ£€æŸ¥ | æ¯æ¬¡é‡æ–°æ£€æŸ¥ | ç¼“å­˜5åˆ†é’Ÿ | ğŸš€ 95%+ æ£€æŸ¥åŠ é€Ÿ |
| åŠ è½½ä½“éªŒ | ç«‹å³é—ªçƒloading | å»¶è¿Ÿ300msæ™ºèƒ½æ˜¾ç¤º | âœ¨ æ¶ˆé™¤é—ªçƒ |
| é¢„å¤„ç† | readeré¡µé¢æ‰å¼€å§‹ | ç‚¹å‡»æ—¶å·²å®Œæˆ | ğŸ“ˆ 50%+ æ¸²æŸ“åŠ é€Ÿ |
| åå°ä¼˜åŒ– | æ—  | è‡ªåŠ¨é¢„æ£€æŸ¥ | ğŸ” ä¸»åŠ¨å‡†å¤‡ |

### ç”¨æˆ·æ„ŸçŸ¥æ”¹è¿›

1. **ç‚¹å‡»å³å¼€**: é¼ æ ‡æ‚¬åœé¢„çƒ­ + ç‚¹å‡»é¢„å¤„ç† = è¿‘ä¹ç¬æ—¶å“åº”
2. **æµç•…å¯¼èˆª**: å¼‚æ­¥å¯¼èˆªæ¶ˆé™¤UIé˜»å¡æ„Ÿ
3. **æ™ºèƒ½loading**: åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼Œé¿å…å¹²æ‰°
4. **åå°ä¼˜åŒ–**: è‡ªåŠ¨é¢„æ£€æŸ¥ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ä¼˜åŒ–

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **BookServiceV2**: ä¹¦ç±å¯ç”¨æ€§æ£€æŸ¥å’Œé¢„å¤„ç†
2. **PreloadManager**: å¤šå±‚æ¬¡é¢„åŠ è½½ç®¡ç†
3. **BookDataStore**: çŠ¶æ€ç¼“å­˜å’ŒæŒä¹…åŒ–
4. **ReaderStore**: æ™ºèƒ½åŠ è½½çŠ¶æ€ç®¡ç†

### æ•°æ®æµ

```
LibraryåŠ è½½ â†’ åå°é¢„æ£€æŸ¥ä¹¦ç±å¯ç”¨æ€§ â†’ ç¼“å­˜çŠ¶æ€
     â†“
ç”¨æˆ·hover â†’ é¢„çƒ­ä¹¦ç± â†’ å‡†å¤‡å¿«é€Ÿæ‰“å¼€
     â†“
ç”¨æˆ·ç‚¹å‡» â†’ ä½¿ç”¨é¢„çƒ­ç»“æœ â†’ å¼‚æ­¥å¯¼èˆª â†’ å¿«é€Ÿæ¸²æŸ“
```

### ç¼“å­˜ç­–ç•¥

- **å¯ç”¨æ€§çŠ¶æ€**: 5åˆ†é’Ÿè¿‡æœŸ
- **ä¹¦ç±æ•°æ®**: 24å°æ—¶è¿‡æœŸ
- **é¢„çƒ­ç»“æœ**: ä¼šè¯æœŸé—´æœ‰æ•ˆ
- **åå°æ£€æŸ¥**: 1ç§’å»¶è¿Ÿå¯åŠ¨ï¼Œä½ä¼˜å…ˆçº§

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `src/services/PreloadManager.ts` - é¢„åŠ è½½ç®¡ç†å™¨
- `BOOK_CLICK_PERFORMANCE_OPTIMIZATION.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- `src/services/BookServiceV2.ts` - æ·»åŠ é¢„å¤„ç†æ–¹æ³•
- `src/store/bookDataStore.ts` - å¢å¼ºçŠ¶æ€ç¼“å­˜
- `src/app/library/page.tsx` - é›†æˆé¢„çƒ­å’Œé¢„åŠ è½½
- `src/app/reader/page.tsx` - æ™ºèƒ½åŠ è½½æŒ‡ç¤ºå™¨
- `src/app/reader/components/ReaderContent.tsx` - ä¼˜åŒ–åŠ è½½çŠ¶æ€

## ğŸ¯ å…³é”®å®ç°ç»†èŠ‚

### 1. é¢„çƒ­ç­–ç•¥
```typescript
// é¼ æ ‡æ‚¬åœæ—¶é¢„çƒ­
onMouseEnter={() => handleBookHover(book.hash)}

// é¢„çƒ­å‡½æ•°
const handleBookHover = async (bookHash: string) => {
  // æ£€æŸ¥æ˜¯å¦å·²é¢„çƒ­ â†’ å¼‚æ­¥é¢„çƒ­ â†’ ç¼“å­˜ç»“æœ
}
```

### 2. ç¼“å­˜ç®¡ç†
```typescript
// å¯ç”¨æ€§æ£€æŸ¥ç¼“å­˜
if (!bookDataStore.isAvailabilityStatusExpired(book.hash)) {
  const cachedStatus = bookDataStore.getAvailabilityStatus(book.hash)
  if (cachedStatus?.available) return true // ä½¿ç”¨ç¼“å­˜
}
```

### 3. æ™ºèƒ½Loading
```typescript
// å»¶è¿Ÿæ˜¾ç¤º + æ¸…ç†æœºåˆ¶
loadingTimeoutRef.current = setTimeout(() => setShowLoading(true), 300)
// å®Œæˆæ—¶æ¸…ç†
if (loadingTimeoutRef.current) clearTimeout(loadingTimeoutRef.current)
```

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ›´æ™ºèƒ½çš„é¢„æµ‹**: åŸºäºç”¨æˆ·è¡Œä¸ºé¢„æµ‹å¯èƒ½æ‰“å¼€çš„ä¹¦ç±
2. **æ¸è¿›å¼é¢„åŠ è½½**: ä¼˜å…ˆåŠ è½½æœ€è¿‘é˜…è¯»çš„ä¹¦ç±
3. **ç½‘ç»œä¼˜åŒ–**: åœ¨äº‘ç«¯åœºæ™¯ä¸‹çš„é¢„ä¸‹è½½ç­–ç•¥
4. **å†…å­˜ç®¡ç†**: è‡ªåŠ¨æ¸…ç†ä¸å¸¸ç”¨çš„ç¼“å­˜æ•°æ®

## âœ… éªŒè¯æ–¹æ³•

### æ€§èƒ½æµ‹è¯•
1. **é¦–æ¬¡ç‚¹å‡»**: æµ‹é‡ä»ç‚¹å‡»åˆ°readeré¡µé¢æ˜¾ç¤ºçš„æ—¶é—´
2. **é‡å¤ç‚¹å‡»**: éªŒè¯ç¼“å­˜åŠ é€Ÿæ•ˆæœ
3. **hoverå“åº”**: æ£€æŸ¥é¢„çƒ­æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
4. **å¹¶å‘æµ‹è¯•**: éªŒè¯å¤šæœ¬ä¹¦ç±çš„å¤„ç†èƒ½åŠ›

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
1. **å“åº”æ€§**: ç‚¹å‡»åUIæ˜¯å¦ç«‹å³å“åº”
2. **æµç•…æ€§**: å¯¼èˆªè¿‡ç¨‹æ˜¯å¦æµç•…
3. **ä¸€è‡´æ€§**: ä¸åŒåœºæ™¯ä¸‹çš„ä½“éªŒæ˜¯å¦ä¸€è‡´

---

é€šè¿‡è¿™å¥—å…¨é¢çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œnew-x-projectçš„ä¹¦ç±ç‚¹å‡»æ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ï¼Œç”¨æˆ·ä½“éªŒè¾¾åˆ°äº†ä¸readesté¡¹ç›®ç›¸å½“çš„æ°´å¹³ã€‚